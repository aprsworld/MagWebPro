#!/usr/bin/php -q
<?
$line=file_get_contents("php://stdin");

$e=json_decode($line,JSON_OBJECT_AS_ARRAY);

if ( JSON_ERROR_NONE !== json_last_error() ) {
	fputs(STDERR,"# error decoding input JSON string. Aborting...\n");
	exit(1);	
}




/* build /etc/network/interfaces file */
$eni=array();
$eni[]="# /etc/network/interfaces generated by APRS World's networkFromJSON";
$eni[]="# source JSON: '$line'";
$eni[]="# this file is auto-generated. Manual changes will be overwritten at next boot.";
$eni[]="";

/* eth0 */
if ( isset($e['net']['interface']['eth0']['mode']) ) {
	/* make shorter $es name to access elements */
	$es=$e['net']['interface']['eth0'];
	/* top of section */
	$eni[]='allow-auto eth0';

	/* stanza */
	if ( 'dhcp'==$es['mode'] ) {
		/* DHCP mode */
		$eni[]='iface eth0 inet dhcp';
	} else if ( 'static'==$es['mode'] ) {
		/* static mode */
		$eni[]='iface eth0 inet static';

		if ( '' != $es['ip'] ) 
			$eni[]=sprintf("\taddress %s",$es['ip']);

		if ( '' != $es['netmask'] ) 
			$eni[]=sprintf("\tnetmask %s",$es['netmask']);

		if ( '' != $es['gateway'] ) 
			$eni[]=sprintf("\tgateway %s",$es['gateway']);
	}
	
	/* add device specific nameservers, if we have any */
	if ( count($es['nameserver']) > 0 ) {
		$dns=implode(" ",$es['nameserver']);
		$eni[]=sprintf("\tdns-nameservers %s",$dns);
	}

	$eni[]='';
}

/* wlan0 */
if ( isset($e['net']['interface']['wlan0']['mode']) ) {
	/* make shorter $es name to access elements */
	$es=$e['net']['interface']['wlan0'];
	/* top of section */
	$eni[]='allow-hotplug wlan0';
	$eni[]='allow-auto wlan0';

	/* stanza */
	if ( 'dhcp'==$es['mode'] ) {
		/* DHCP mode */
		$eni[]='iface wlan0 inet dhcp';
	} else if ( 'static'==$es['mode'] ) {
		/* static mode */
		$eni[]='iface wlan0 inet static';

		if ( '' != $es['ip'] ) 
			$eni[]=sprintf("\taddress %s",$es['ip']);

		if ( '' != $es['netmask'] ) 
			$eni[]=sprintf("\tnetmask %s",$es['netmask']);

		if ( '' != $es['gateway'] ) 
			$eni[]=sprintf("\tgateway %s",$es['gateway']);
	}

	/* add device specific nameservers, if we have any */
	if ( isset($es['nameserver']) && count($es['nameserver']) > 0 ) {
		$dns=implode(" ",$es['nameserver']);
		$eni[]=sprintf("\tdns-nameservers %s",$dns);
	}

	
	$eni[]="\t# wpa-supplicant options";
	$eni[]="\twpa-ap-scan 1";
	$eni[]="\twpa-scan-ssid 1";


	/* wpa ssid */
	if ( isset($es['ssid']) && '' != $es['ssid'] ) {
		$eni[]=sprintf("\twpa-ssid \"%s\"",$es['ssid']);
	}

	/* wpa psk */
	if ( isset($es['psk']) && '' != $es['psk'] ) {
		$eni[]=sprintf("\twpa-psk \"%s\"",$es['psk']);
	}

	$eni[]='';
}



$interfacesFile=implode("\n",$eni);
echo $interfacesFile;



?>
