#!/usr/bin/php -q
<?
function readEEPROM($startAddress,$nBytes) {
	$cmd=sprintf("eeprom_2464 --read /dev/stdout --string --start-address %d --n-bytes %d 2>/dev/null",$startAddress,$nBytes);

	return shell_exec($cmd);
}


$e=array();

$e['net']['interface']['eth0']['mode']          ='static';
$e['net']['interface']['eth0']['ip']            ='192.168.10.189';
$e['net']['interface']['eth0']['netmask']       ='255.255.255.0';
$e['net']['interface']['eth0']['gateway']       ='192.168.10.1';
$e['net']['interface']['eth0']['nameserver'][0] ='8.8.8.8';
$e['net']['interface']['eth0']['nameserver'][1] ='8.8.4.4';

$e['net']['interface']['wlan0']['mode']         ='dhcp';
$e['net']['interface']['wlan0']['ip']           ='192.168.10.77';
$e['net']['interface']['wlan0']['netmask']      ='255.255.255.0';
$e['net']['interface']['wlan0']['gateway']      ='192.168.10.1';
$e['net']['interface']['wlan0']['ssid']         ='aprsworld';
$e['net']['interface']['wlan0']['psk']          ='zestopenguin';

//print_r($e);

$json=json_encode($e);
//printf("# json encoded strlen=%d\n",strlen($json));
//echo $json;

//print_r(json_decode($json,JSON_OBJECT_AS_ARRAY));



/* build /etc/network/interfaces file */
$eni=array();
$eni[]="# /etc/network/interfaces generated by APRS World's eepromNetConfig.";
$eni[]="# this file is auto-generated. Manual changes will be overwritten at next boot.";
$eni[]="";

/* eth0 */
if ( isset($e['net']['interface']['eth0']['mode']) ) {
	/* make shorter $es name to access elements */
	$es=$e['net']['interface']['eth0'];
	/* top of section */
	$eni[]='allow-auto eth0';

	/* stanza */
	if ( 'dhcp'==$es['mode'] ) {
		/* DHCP mode */
		$eni[]='iface eth0 inet dhcp';
	} else if ( 'static'==$es['mode'] ) {
		/* static mode */
		$eni[]='iface eth0 inet static';

		if ( '' != $es['ip'] ) 
			$eni[]=sprintf("\taddress %s",$es['ip']);

		if ( '' != $es['netmask'] ) 
			$eni[]=sprintf("\tnetmask %s",$es['netmask']);

		if ( '' != $es['gateway'] ) 
			$eni[]=sprintf("\tgateway %s",$es['gateway']);
	}
	
	/* add device specific nameservers, if we have any */
	if ( count($es['nameserver']) > 0 ) {
		$dns=implode(" ",$es['nameserver']);
		$eni[]=sprintf("\tdns-nameservers %s",$dns);
	}

	$eni[]='';
}

/* wlan0 */
if ( isset($e['net']['interface']['wlan0']['mode']) ) {
	/* make shorter $es name to access elements */
	$es=$e['net']['interface']['wlan0'];
	/* top of section */
	$eni[]='allow-hotplug wlan0';
	$eni[]='allow-auto wlan0';

	/* stanza */
	if ( 'dhcp'==$es['mode'] ) {
		/* DHCP mode */
		$eni[]='iface wlan0 inet dhcp';
	} else if ( 'static'==$es['mode'] ) {
		/* static mode */
		$eni[]='iface wlan0 inet static';

		if ( '' != $es['ip'] ) 
			$eni[]=sprintf("\taddress %s",$es['ip']);

		if ( '' != $es['netmask'] ) 
			$eni[]=sprintf("\tnetmask %s",$es['netmask']);

		if ( '' != $es['gateway'] ) 
			$eni[]=sprintf("\tgateway %s",$es['gateway']);
	}

	/* add device specific nameservers, if we have any */
	if ( isset($es['nameserver']) && count($es['nameserver']) > 0 ) {
		$dns=implode(" ",$es['nameserver']);
		$eni[]=sprintf("\tdns-nameservers %s",$dns);
	}

	
	$eni[]="\t# wpa-supplicant options";
	$eni[]="\twpa-ap-scan 1";
	$eni[]="\twpa-scan-ssid 1";


	/* wpa ssid */
	if ( isset($es['ssid']) && '' != $es['ssid'] ) {
		$eni[]=sprintf("\twpa-ssid \"%s\"",$es['ssid']);
	}

	/* wpa psk */
	if ( isset($es['psk']) && '' != $es['psk'] ) {
		$eni[]=sprintf("\twpa-psk \"%s\"",$es['psk']);
	}

	$eni[]='';
}



$interfacesFile=implode("\n",$eni);

printf("# /etc/network/interfaces is now:\n%s\n",$interfacesFile);


?>
